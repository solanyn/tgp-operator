name: PR Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: DeterminateSystems/nix-installer-action@main
    
    - uses: DeterminateSystems/magic-nix-cache-action@main
    
    - name: Setup development environment
      run: |
        nix develop --command task setup
    
    - name: Run linting and formatting checks
      run: |
        nix develop --command task lint:all
    
    - name: Run tests
      run: |
        nix develop --command task test:all
    
    - name: Build operator
      run: |
        nix develop --command task dev:build
    
    - name: Validate Helm chart
      run: |
        nix develop --command task chart:validate
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          cover.out
          test-results.xml
        retention-days: 3

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: DeterminateSystems/nix-installer-action@main
    
    - uses: DeterminateSystems/magic-nix-cache-action@main
    
    - name: Run security checks
      run: |
        nix develop --command golangci-lint run --enable gosec ./...